<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - E.I.O</title>
    <link rel="stylesheet" href="design-system.css?v=13">
    <link rel="stylesheet" href="dashboard.css?v=13">
    <link rel="stylesheet" href="analytics.css?v=13">
    <style>
        .eio-page-content {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        .eio-content-section {
            margin-top: 0 !important;
            padding-top: 16px !important;
        }

        .eio-kpi-grid {
            margin-top: 0 !important;
        }

        .eio-no-data {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
            background: rgba(127, 90, 240, 0.05);
            border: 1px dashed rgba(127, 90, 240, 0.2);
            border-radius: 12px;
            margin: 20px 0;
        }

        .eio-no-data-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .eio-no-data-text {
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .eio-no-data-hint {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .eio-sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #25d366;
        }

        .eio-sync-dot {
            width: 8px;
            height: 8px;
            background: #25d366;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="eio-dashboard-body">
    <!-- Sidebar -->
    <aside class="eio-sidebar">
        <div class="eio-sidebar-header">
            <img src="public/assets/official_brand_rocket.png" alt="E.I.O" class="eio-sidebar-logo">
            <div class="eio-sidebar-title">
                <span class="eio-title-main">E.I.O</span>
                <span class="eio-title-sub">Analytics</span>
            </div>
        </div>

        <nav class="eio-sidebar-nav">
            <a href="dashboard.html" class="eio-nav-item">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 10L10 3L17 10M5 8V17H8V13H12V17H15V8" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Dashboard</span>
            </a>

            <a href="#overview" class="eio-nav-item eio-nav-item-active" data-page="overview">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 17V9M10 17V3M17 17V13" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Vis√£o Geral</span>
            </a>

            <a href="#actions" class="eio-nav-item" data-page="actions">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 14L8 9L12 13L17 8M17 8V12M17 8H13" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>A√ß√µes Executadas</span>
            </a>

            <a href="#leads" class="eio-nav-item" data-page="leads">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="7" r="4" stroke="currentColor" stroke-width="2" />
                    <path d="M3 18C3 14.13 6.13 11 10 11C13.87 11 17 14.13 17 18" stroke="currentColor"
                        stroke-width="2" />
                </svg>
                <span>Leads Extra√≠dos</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="eio-main-content">
        <!-- Topbar -->
        <header class="eio-topbar">
            <div class="eio-topbar-left">
                <h1 class="eio-page-title">Analytics</h1>
            </div>

            <div class="eio-topbar-right">
                <div class="eio-sync-status">
                    <span class="eio-sync-dot"></span>
                    <span>Sincronizado com extens√£o</span>
                </div>
                <select class="eio-select-period" id="periodSelect">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30" selected>√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                    <option value="all">Todo o per√≠odo</option>
                </select>
            </div>
        </header>

        <!-- Page Content -->
        <div class="eio-page-content" id="pageContent">
            <!-- Overview Section -->
            <div class="eio-content-section eio-content-active" data-section="overview">
                <!-- KPIs Grid -->
                <div class="eio-kpi-grid">
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(33, 150, 243, 0.15); color: #2196F3;">
                                ‚ûï
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="followsTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalFollows">0</div>
                        <div class="eio-kpi-label">Total de Follows</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(244, 67, 54, 0.15); color: #F44336;">
                                ‚ù§Ô∏è
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="likesTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalLikes">0</div>
                        <div class="eio-kpi-label">Total de Curtidas</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(76, 175, 80, 0.15); color: #4CAF50;">
                                üí¨
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="commentsTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalComments">0</div>
                        <div class="eio-kpi-label">Total de Coment√°rios</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(156, 39, 176, 0.15); color: #9C27B0;">
                                ‚úâÔ∏è
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="dmsTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalDMs">0</div>
                        <div class="eio-kpi-label">DMs Enviadas</div>
                    </div>
                </div>

                <!-- More KPIs -->
                <div class="eio-kpi-grid" style="margin-top: 20px;">
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(255, 152, 0, 0.15); color: #FF9800;">
                                ‚ûñ
                            </div>
                            <span class="eio-kpi-trend eio-trend-neutral" id="unfollowsTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalUnfollows">0</div>
                        <div class="eio-kpi-label">Total de Unfollows</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(0, 188, 212, 0.15); color: #00BCD4;">
                                üëÅÔ∏è
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="storiesTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalStories">0</div>
                        <div class="eio-kpi-label">Stories Vistos</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(127, 90, 240, 0.15); color: #7F5AF0;">
                                üë•
                            </div>
                            <span class="eio-kpi-trend eio-trend-up" id="leadsTrend">--</span>
                        </div>
                        <div class="eio-kpi-value" id="totalLeads">0</div>
                        <div class="eio-kpi-label">Leads Extra√≠dos</div>
                    </div>

                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(233, 30, 99, 0.15); color: #E91E63;">
                                ‚ö°
                            </div>
                        </div>
                        <div class="eio-kpi-value" id="totalActions">0</div>
                        <div class="eio-kpi-label">Total de A√ß√µes</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="eio-card" style="margin-top: 20px;">
                    <div class="eio-card-header">
                        <h3>üìä A√ß√µes por Dia</h3>
                    </div>
                    <div class="eio-chart-wrapper" id="actionsChartWrapper">
                        <canvas id="actionsChart"></canvas>
                    </div>
                    <div class="eio-no-data" id="noChartData" style="display: none;">
                        <div class="eio-no-data-icon">üìà</div>
                        <div class="eio-no-data-text">Nenhuma a√ß√£o registrada ainda</div>
                        <div class="eio-no-data-hint">Use a extens√£o para executar a√ß√µes e ver os dados aqui</div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="eio-content-section" data-section="actions">
                <div class="eio-card">
                    <div class="eio-card-header">
                        <h3>üìã Hist√≥rico de A√ß√µes</h3>
                        <button class="eio-btn eio-btn-ghost eio-btn-sm" id="btnExportActions">
                            üì• Exportar CSV
                        </button>
                    </div>
                    <div class="eio-actions-table-wrapper">
                        <table class="eio-table" id="actionsTable">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>A√ß√£o</th>
                                    <th>Perfil</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="actionsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="eio-no-data" id="noActionsData" style="display: none;">
                        <div class="eio-no-data-icon">üìù</div>
                        <div class="eio-no-data-text">Nenhuma a√ß√£o executada ainda</div>
                        <div class="eio-no-data-hint">V√° at√© a extens√£o e execute a√ß√µes como seguir, curtir ou comentar
                        </div>
                    </div>
                </div>

                <!-- Actions by Type -->
                <div class="eio-analytics-grid" style="margin-top: 20px;">
                    <div class="eio-card">
                        <div class="eio-card-header">
                            <h3>üéØ A√ß√µes por Tipo</h3>
                        </div>
                        <div class="eio-stats-list" id="actionsByType">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="eio-card">
                        <div class="eio-card-header">
                            <h3>‚è∞ A√ß√µes por Hor√°rio</h3>
                        </div>
                        <div class="eio-stats-list" id="actionsByHour">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leads Section -->
            <div class="eio-content-section" data-section="leads">
                <div class="eio-card">
                    <div class="eio-card-header">
                        <h3>üë• Leads Extra√≠dos</h3>
                        <button class="eio-btn eio-btn-ghost eio-btn-sm" id="btnExportLeads">
                            üì• Exportar CSV
                        </button>
                    </div>
                    <div class="eio-leads-grid" id="leadsGrid">
                        <!-- Populated by JS -->
                    </div>
                    <div class="eio-no-data" id="noLeadsData" style="display: none;">
                        <div class="eio-no-data-icon">üë•</div>
                        <div class="eio-no-data-text">Nenhum lead extra√≠do ainda</div>
                        <div class="eio-no-data-hint">Use a extens√£o para carregar seguidores/seguindo e extrair leads
                        </div>
                    </div>
                </div>

                <!-- Leads Stats -->
                <div class="eio-kpi-grid" style="margin-top: 20px;">
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(76, 175, 80, 0.15); color: #4CAF50;">
                                üî•
                            </div>
                        </div>
                        <div class="eio-kpi-value" id="hotLeads">0</div>
                        <div class="eio-kpi-label">Leads Quentes</div>
                    </div>
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(255, 152, 0, 0.15); color: #FF9800;">
                                üå°Ô∏è
                            </div>
                        </div>
                        <div class="eio-kpi-value" id="warmLeads">0</div>
                        <div class="eio-kpi-label">Leads Mornos</div>
                    </div>
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(33, 150, 243, 0.15); color: #2196F3;">
                                ‚ùÑÔ∏è
                            </div>
                        </div>
                        <div class="eio-kpi-value" id="coldLeads">0</div>
                        <div class="eio-kpi-label">Leads Frios</div>
                    </div>
                    <div class="eio-kpi-card">
                        <div class="eio-kpi-header">
                            <div class="eio-kpi-icon" style="background: rgba(156, 39, 176, 0.15); color: #9C27B0;">
                                üìß
                            </div>
                        </div>
                        <div class="eio-kpi-value" id="contactedLeads">0</div>
                        <div class="eio-kpi-label">Leads Contactados</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANALYTICS - DADOS REAIS DA EXTENS√ÉO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let actionsHistory = [];
        let leadsData = [];
        let actionsChart = null;
        const EXTENSION_ID = 'YOUR_EXTENSION_ID'; // Ser√° detectado automaticamente

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage();
            setupNavigation();
            setupPeriodFilter();
            setupExportButtons();

            // Tentar buscar dados da extens√£o
            tryFetchFromExtension();
        });

        // Tentar buscar dados da extens√£o
        async function tryFetchFromExtension() {
            try {
                // Verificar se a extens√£o est√° instalada
                if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
                    // Tentar se conectar com a extens√£o
                    chrome.runtime.sendMessage({ action: 'getAnalyticsData' }, (response) => {
                        if (chrome.runtime.lastError) {
                            console.log('Extens√£o n√£o encontrada ou n√£o respondeu:', chrome.runtime.lastError.message);
                            showExtensionHint();
                            return;
                        }

                        if (response && response.success) {
                            console.log('‚úÖ Dados recebidos da extens√£o:', response);
                            actionsHistory = response.history || [];
                            updateDashboard();
                            hideExtensionHint();
                        }
                    });
                } else {
                    console.log('Chrome runtime n√£o dispon√≠vel');
                    showExtensionHint();
                }
            } catch (error) {
                console.log('Erro ao conectar com extens√£o:', error);
                showExtensionHint();
            }
        }

        function showExtensionHint() {
            // Mostrar dica para instalar/sincronizar extens√£o se n√£o houver dados
            if (actionsHistory.length === 0) {
                const syncStatus = document.querySelector('.eio-sync-status');
                if (syncStatus) {
                    syncStatus.innerHTML = `
                        <span class="eio-sync-dot" style="background: #FFC107;"></span>
                        <span>Extens√£o n√£o detectada</span>
                    `;
                    syncStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    syncStatus.style.borderColor = 'rgba(255, 193, 7, 0.2)';
                    syncStatus.style.color = '#FFC107';
                }
            }
        }

        function hideExtensionHint() {
            const syncStatus = document.querySelector('.eio-sync-status');
            if (syncStatus) {
                syncStatus.innerHTML = `
                    <span class="eio-sync-dot"></span>
                    <span>Sincronizado com extens√£o</span>
                `;
                syncStatus.style.background = 'rgba(37, 211, 102, 0.1)';
                syncStatus.style.borderColor = 'rgba(37, 211, 102, 0.2)';
                syncStatus.style.color = '#25d366';
            }
        }

        // Carregar dados do localStorage
        function loadDataFromStorage() {
            // Carregar hist√≥rico de a√ß√µes
            const savedActions = localStorage.getItem('eio_actions_history');
            if (savedActions) {
                actionsHistory = JSON.parse(savedActions);
            }

            // Carregar leads do CRM
            const savedLeads = localStorage.getItem('eio_crm_leads');
            if (savedLeads) {
                leadsData = JSON.parse(savedLeads);
            }

            // Carregar estat√≠sticas da extens√£o
            const savedStats = localStorage.getItem('eio_extension_stats');
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                mergeExtensionStats(stats);
            }

            updateDashboard();
        }

        // Mesclar estat√≠sticas da extens√£o
        function mergeExtensionStats(stats) {
            if (!stats) return;

            // Se temos estat√≠sticas da extens√£o, usar elas
            if (stats.totalActions) {
                // Atualizar contadores com dados da extens√£o
            }
        }

        // Atualizar todo o dashboard
        function updateDashboard() {
            const period = document.getElementById('periodSelect').value;
            const filteredActions = filterByPeriod(actionsHistory, period);

            updateKPIs(filteredActions);
            updateActionsTable(filteredActions);
            updateActionsByType(filteredActions);
            updateActionsByHour(filteredActions);
            updateChart(filteredActions);
            updateLeads();
        }

        // Filtrar por per√≠odo
        function filterByPeriod(data, period) {
            if (period === 'all') return data;

            const days = parseInt(period);
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);

            return data.filter(item => {
                const itemDate = new Date(item.timestamp || item.date);
                return itemDate >= cutoff;
            });
        }

        // Atualizar KPIs
        function updateKPIs(actions) {
            const counts = {
                follow: 0,
                like: 0,
                comment: 0,
                dm: 0,
                unfollow: 0,
                story: 0
            };

            actions.forEach(action => {
                const type = action.type || action.action;
                if (counts.hasOwnProperty(type)) {
                    counts[type]++;
                }
            });

            document.getElementById('totalFollows').textContent = formatNumber(counts.follow);
            document.getElementById('totalLikes').textContent = formatNumber(counts.like);
            document.getElementById('totalComments').textContent = formatNumber(counts.comment);
            document.getElementById('totalDMs').textContent = formatNumber(counts.dm);
            document.getElementById('totalUnfollows').textContent = formatNumber(counts.unfollow);
            document.getElementById('totalStories').textContent = formatNumber(counts.story);
            document.getElementById('totalLeads').textContent = formatNumber(leadsData.length);
            document.getElementById('totalActions').textContent = formatNumber(actions.length);
        }

        // Atualizar tabela de a√ß√µes
        function updateActionsTable(actions) {
            const tbody = document.getElementById('actionsTableBody');
            const noData = document.getElementById('noActionsData');
            const table = document.getElementById('actionsTable');

            if (actions.length === 0) {
                tbody.innerHTML = '';
                table.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noData.style.display = 'none';

            // Mostrar √∫ltimas 50 a√ß√µes
            const recentActions = actions.slice(-50).reverse();

            tbody.innerHTML = recentActions.map(action => {
                const date = new Date(action.timestamp || action.date);
                const formattedDate = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const actionType = action.type || action.action;
                const actionEmoji = getActionEmoji(actionType);
                const statusClass = action.success !== false ? 'eio-status-success' : 'eio-status-error';
                const statusText = action.success !== false ? '‚úÖ Sucesso' : '‚ùå Falhou';

                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${actionEmoji} ${translateAction(actionType)}</td>
                        <td>@${action.username || action.target || '--'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Atualizar a√ß√µes por tipo
        function updateActionsByType(actions) {
            const container = document.getElementById('actionsByType');
            const typeCounts = {};

            actions.forEach(action => {
                const type = action.type || action.action;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const total = actions.length || 1;
            const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);

            if (sortedTypes.length === 0) {
                container.innerHTML = '<div class="eio-no-data"><div class="eio-no-data-text">Sem dados</div></div>';
                return;
            }

            container.innerHTML = sortedTypes.map(([type, count]) => {
                const percent = Math.round((count / total) * 100);
                const color = getActionColor(type);
                return `
                    <div class="eio-stat-item">
                        <span class="eio-stat-label">${getActionEmoji(type)} ${translateAction(type)}</span>
                        <div class="eio-stat-bar">
                            <div class="eio-stat-fill" style="width: ${percent}%; background: ${color};"></div>
                        </div>
                        <span class="eio-stat-value">${count} (${percent}%)</span>
                    </div>
                `;
            }).join('');
        }

        // Atualizar a√ß√µes por hor√°rio
        function updateActionsByHour(actions) {
            const container = document.getElementById('actionsByHour');
            const hourCounts = {};

            actions.forEach(action => {
                const date = new Date(action.timestamp || action.date);
                const hour = date.getHours();
                const period = hour < 6 ? 'Madrugada (00-06)' :
                    hour < 12 ? 'Manh√£ (06-12)' :
                        hour < 18 ? 'Tarde (12-18)' : 'Noite (18-24)';
                hourCounts[period] = (hourCounts[period] || 0) + 1;
            });

            const total = actions.length || 1;
            const periods = ['Manh√£ (06-12)', 'Tarde (12-18)', 'Noite (18-24)', 'Madrugada (00-06)'];

            container.innerHTML = periods.map(period => {
                const count = hourCounts[period] || 0;
                const percent = Math.round((count / total) * 100);
                return `
                    <div class="eio-stat-item">
                        <span class="eio-stat-label">${period}</span>
                        <div class="eio-stat-bar">
                            <div class="eio-stat-fill" style="width: ${percent}%; background: #7F5AF0;"></div>
                        </div>
                        <span class="eio-stat-value">${count} (${percent}%)</span>
                    </div>
                `;
            }).join('');
        }

        // Atualizar gr√°fico
        function updateChart(actions) {
            const wrapper = document.getElementById('actionsChartWrapper');
            const noData = document.getElementById('noChartData');

            if (actions.length === 0) {
                wrapper.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            wrapper.style.display = 'block';
            noData.style.display = 'none';

            // Agrupar por dia
            const dailyCounts = {};
            actions.forEach(action => {
                const date = new Date(action.timestamp || action.date);
                const dayKey = date.toISOString().split('T')[0];
                dailyCounts[dayKey] = (dailyCounts[dayKey] || 0) + 1;
            });

            const labels = Object.keys(dailyCounts).sort();
            const data = labels.map(day => dailyCounts[day]);

            const ctx = document.getElementById('actionsChart').getContext('2d');

            if (actionsChart) {
                actionsChart.destroy();
            }

            actionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'A√ß√µes',
                        data: data,
                        borderColor: '#7F5AF0',
                        backgroundColor: 'rgba(127, 90, 240, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        // Atualizar leads
        function updateLeads() {
            const grid = document.getElementById('leadsGrid');
            const noData = document.getElementById('noLeadsData');

            if (leadsData.length === 0) {
                grid.innerHTML = '';
                grid.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noData.style.display = 'none';

            // Contar por qualifica√ß√£o
            let hot = 0, warm = 0, cold = 0, contacted = 0;

            leadsData.forEach(lead => {
                if (lead.stage === 'qualificado' || lead.score >= 70) hot++;
                else if (lead.stage === 'negociacao' || lead.score >= 40) warm++;
                else cold++;
                if (lead.contacted) contacted++;
            });

            document.getElementById('hotLeads').textContent = hot;
            document.getElementById('warmLeads').textContent = warm;
            document.getElementById('coldLeads').textContent = cold;
            document.getElementById('contactedLeads').textContent = contacted;

            // Mostrar √∫ltimos leads
            grid.innerHTML = leadsData.slice(0, 20).map(lead => `
                <div class="eio-lead-card">
                    <img src="${lead.avatar || 'https://via.placeholder.com/50'}" alt="${lead.username}" class="eio-lead-avatar">
                    <div class="eio-lead-info">
                        <strong>@${lead.username}</strong>
                        <span>${lead.fullName || ''}</span>
                    </div>
                    <span class="eio-lead-stage eio-stage-${lead.stage || 'prospeccao'}">${translateStage(lead.stage)}</span>
                </div>
            `).join('');
        }

        // Helpers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function getActionEmoji(type) {
            const emojis = {
                follow: '‚ûï', unfollow: '‚ûñ', like: '‚ù§Ô∏è',
                comment: 'üí¨', dm: '‚úâÔ∏è', story: 'üëÅÔ∏è'
            };
            return emojis[type] || '‚ö°';
        }

        function getActionColor(type) {
            const colors = {
                follow: '#2196F3', unfollow: '#FF9800', like: '#F44336',
                comment: '#4CAF50', dm: '#9C27B0', story: '#00BCD4'
            };
            return colors[type] || '#7F5AF0';
        }

        function translateAction(type) {
            const translations = {
                follow: 'Seguir', unfollow: 'Deixar de Seguir', like: 'Curtir',
                comment: 'Comentar', dm: 'Enviar DM', story: 'Ver Story'
            };
            return translations[type] || type;
        }

        function translateStage(stage) {
            const translations = {
                prospeccao: 'Prospec√ß√£o', qualificado: 'Qualificado',
                negociacao: 'Negocia√ß√£o', fechado: 'Fechado'
            };
            return translations[stage] || 'Prospec√ß√£o';
        }

        // Navega√ß√£o
        function setupNavigation() {
            document.querySelectorAll('.eio-nav-item[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;

                    document.querySelectorAll('.eio-nav-item').forEach(l => l.classList.remove('eio-nav-item-active'));
                    link.classList.add('eio-nav-item-active');

                    document.querySelectorAll('.eio-content-section').forEach(s => s.classList.remove('eio-content-active'));
                    document.querySelector(`[data-section="${page}"]`).classList.add('eio-content-active');
                });
            });
        }

        // Filtro de per√≠odo
        function setupPeriodFilter() {
            document.getElementById('periodSelect').addEventListener('change', updateDashboard);
        }

        // Bot√µes de exporta√ß√£o
        function setupExportButtons() {
            document.getElementById('btnExportActions')?.addEventListener('click', () => {
                exportToCSV(actionsHistory, 'eio_actions_history.csv');
            });

            document.getElementById('btnExportLeads')?.addEventListener('click', () => {
                exportToCSV(leadsData, 'eio_leads.csv');
            });
        }

        function exportToCSV(data, filename) {
            if (data.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }

            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Receber dados da extens√£o via postMessage
        window.addEventListener('message', (event) => {
            if (event.data.type === 'EIO_STATS_UPDATE') {
                localStorage.setItem('eio_extension_stats', JSON.stringify(event.data.stats));
                loadDataFromStorage();
            }

            if (event.data.type === 'EIO_ACTION_COMPLETED') {
                actionsHistory.push(event.data.action);
                localStorage.setItem('eio_actions_history', JSON.stringify(actionsHistory));
                updateDashboard();
            }
        });
    </script>
</body>

</html>